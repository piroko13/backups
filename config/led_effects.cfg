 # Macros for setting the status leds on the Ender 3 Neo (or for any neopixel-type leds)

# You will need to configure a neopixel. See https://klipper3d.org/Config_Reference.html#neopixel
# for configuration details

###########################
#       Instructions      #
###########################
#How to use:
#
#    1. Copy this .cfg file into your Klipper config directory and the add [include led_effects.cfg]
#       to the top of your printer.cfg in order for register the LEDs and macros with Klipper.
#    2. Define your LEDs by editing [neopixel sb_leads] below and entering the data pin from your control board
#       as well as the collor order.
#
#         Note: RGB and RGBW are different and must be defined explicitly in the color order.
#
#           RGBW LEDs will have a visible yellow-ish phosphor section to the chip. If your LEDs do not have
#           this yellow portion, you have RGB LEDs.
#
#    3. Save your config and restart Klipper.
#
#         Note: We set RED and BLUE to 1.0 to make it easier for users and supporters to detect
#               misconfigurations or miswiring. The default color format is for Neopixels with a dedicated
#               white LED. On startup, all three SB LEDs should light up.
#
#               If you get random colors across your LEDs, change the color_order to GRB and restart. Then
#               omit the W for each suggested color_order in the next paragraph.
#
#               If you get MAGENTA, your color order is correct. If you get CYAN, you need to use RGBW. If
#               you get YELLOW, you need to use BRGW (note that BRG is only supported in the latest Klipper
#               version).
#
#    4. Once you have confirmed that the LEDs are set up correcctly, you must now decide where you want
#       these macros called up... which means adding them to your existing gcode macros. NOTHING will happen
#       unless you add the STATUS_??? macros to your existing gcode macros.
#
#         Example: add STATUS_LEVELING to the beginning of your QGL gcode macro, and the add STATUS_READY
#                  to the end of it to set the logo LED and nozzle LEDs back to the 'ready' state.
#
#         Example: add STATUS_CLEANING to the beginning of your nozzle-cleaning macro, and then STATUS_READY
#                  to the end of it to return the LEDs bacj to 'ready' state.
#
##########################
#    END INSTRUCTIONS    #
##########################

[neopixel sb_leds]
pin: PA8
# The pin connected to the neopixel. This parameter must be provided.
chain_count: 10
# The number of Neopixel chips that are "daisy chained" to the
# provided pin. The default is 1 (which indicates only a single
# Nepixel is connected to the pin).
color_order: GRB
# Set the pixel order required by the LED harware. Options are GRB,
# RGB, GRBW, or RGBW. The default is GRB.
initial_RED: 1.0
initial_GREEN: 0.0
initial_BLUE: 1.0
# Sets the initial LED color of the Neopixel. Each value should be
# between 0.0 and 1.0. The WHITE option is only available on RGBW
# LEDs. The default for each color os 0.#
[neopixel SKR_screen]
pin: PA15
chain_count: 3
color_order: RGB
initial_RED: 1.0
initial_GREEN: 0.0
initial_BLUE: 1.0

##########################
# LED Effects Animations #
##########################

##################
## logo effects ##
##################

[led_effect sb_logo_busy]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (1,0,0)

[led_effect sb_logo_cleaning]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.0, 0.02, 0.5)

[led_effect sb_logo_calibrating_z]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.0, 0.0, 0.35)

[led_effect sb_logo_heating]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (1, 0.18, 0)

[led_effect sb_logo_cooling]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0, 0, 1)

[led_effect sb_logo_homing]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.0, 0.6, 0.2)

[led_effect sb_logo_leveling]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.5, 0.1, 0.4)

[led_effect sb_logo_meshing]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.5, 1.0, 0.0)

[led_effect sb_logo_printing]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  static 3 1 add (1.0, 1.0, 1.0)

[led_effect sb_logo_standby]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.01, 0.01, 0.01)

[led_effect sb_logo_part_ready]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  breathing 3 1 top (0.0, 1.0, 0.0)

####################
## nozzle effects ##
####################

[led_effect sb_nozzle_heating]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (9,10)
layers:
  breathing 3 1 top (1.0, 0.18, 0.0)

[led_effect sb_nozzle_cooling]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (9,10)
layers:
  breathing 3 1 top (0.1, 0.1, 1.0)

[led_effect sb_nozzle_standby]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (9,10)
layers:
  breathing 3 1 top (0.6, 0.0, 0.0)

[led_effect sb_nozzle_printing]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (9,10)
layers:
  static 3 1 top (1.0, 1.0, 1.0)

[led_effect sb_nozzle_part_ready]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (9,10)
layers:
  breathing 3 1 top (0.6, 1.0, 0.1)

###############################
## SKR Screen Button effects ##
###############################

[led_effect SKR_screen_button_heating]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (1,2)
layers:
  breathing 3 1 top (1.0, 0.18, 0.0)

[led_effect SKR_screen_button_cooling]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (1,2)
layers:
  breathing 3 1 top (0.1, 0.1, 1.0)

[led_effect SKR_screen_button_printing]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (1,2)
layers:
  static 3 1 top (1.0, 1.0, 1.0)

[led_effect SKR_screen_button_part_ready]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (1,2)
layers:
  breathing 3 1 top (0.6, 1.0, 0.1)


########################
## SKR Screen effects ##
########################

[led_effect SKR_screen_heating]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (3)
layers:
  static 3 1 top (1.0, 0.18, 0.0)

[led_effect SKR_screen_cooling]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (3)
layers:
  static 3 1 top (0.1, 0.1, 1.0)

[led_effect SKR_screen_printing]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (3)
layers:
  static 3 1 top (1.0, 1.0, 1.0)

[led_effect SKR_screen_part_ready]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (3)
layers:
  static 3 1 top (1.0, 1.0, 1.0)

#####################
## all led effects ##
#####################

[led_effect sb_critical_error]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds
layers:
  strobe 1 1.5 add (1.0, 1.0, 1.0)
  breathing 2 0 difference (0.95, 0.0, 0.0)
  static 1 0 top (1.0, 0.0, 0.0)
run_on_error: true

[led_effect rainbow]
autostart: true
frame_rate: 24
leds:
  neopixel:sb_leds
layers:
  gradient 0.3 1 add (0.3, 0.0, 0.0),(0.0, 9.3, 0.0),(0.0, 0.0, 0.3)

#######################
# LED Effects Statics #
#######################

[led_effect set_nozzle_leds]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (9,10)
layers:
  static 0 0 top (1.0, 1.0, 1.0)

[led_effect set_logo_leds]
autostart: false
frame_rate: 24
leds:
  neopixel:sb_leds (1-8)
layers:
  static 0 0 top (1.0, 1.0, 1.0)

[led_effect set_SKR_screen_button_leds]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (1,2)
layers:
  static 0 0 top (1.0, 1.0, 1.0)

[led_effect set_SKR_screen_leds]
autostart: false
frame_rate: 24
leds:
  neopixel:SKR_screen (3)
layers:
  static 0 0 top (1.0, 1.0, 1.0)

##############
# The Macros #
##############

[gcode_macro set_logo_leds_off]
gcode:
  SET_LED_EFFECT EFFECT=set_logo_leds STOP=1

[gcode_macro set_logo_leds_on]
gcode:
  SET_LED_EFFECT EFFECT=set_logo_leds

[gcode_macro set_nozzle_leds_on]
gcode:
  SET_LED_EFFECT EFFECT=set_nozzle_leds

[gcode_macro set_nozzle_leds_off]
gcode:
  SET_LED_EFFECT EFFECT=set_nozzle_leds STOP=1

[gcode_macro set_SKR_screen_button_leds_on]
gcode:
  SET_LED_EFFECT EFFECT=set_SKR_screen_button_leds

[gcode_macro set_SKR_screen_button_leds_off]
gcode:
  SET_LED_EFFECT EFFECT=set_SKR_screen_button_leds STOP=1

[gcode_macro set_SKR_screen_leds_on]
gcode:
  SET_LED_EFFECT EFFECT=set_SKR_screen_leds

[gcode_macro set_SKR_screen_leds_off]
gcode:
  SET_LED_EFFECT EFFECT=set_SKR_screen_leds STOP=1

[gcode_macro status_off]
gcode:
  STOP_LED_EFFECTS

[gcode_macro status_ready]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=rainbow

[gcode_macro status_part_ready]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_nozzle_part_ready
  SET_LED_EFFECT EFFECT=sb_logo_part_ready
  SET_LED_EFFECT EFFECT=SKR_screen_button_part_ready
  SET_LED_EFFECT EFFECT=SKR_screen_part_ready

[gcode_macro status_busy]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_nozzle_part_ready
  SET_LED_EFFECT EFFECT=sb_logo_part_ready

[gcode_macro status_heating]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_heating
  SET_LED_EFFECT EFFECT=sb_nozzle_heating
  SET_LED_EFFECT EFFECT=SKR_screen_button_heating
  SET_LED_EFFECT EFFECT=SKR_screen_heating

[gcode_macro status_cooling]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_cooling
  SET_LED_EFFECT EFFECT=sb_nozzle_cooling
  SET_LED_EFFECT EFFECT=SKR_screen_cooling
  SET_LED_EFFECT EFFECT=SKR_screen_button_cooling

[gcode_macro status_leveling]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_leveling
  set_nozzle_leds_on

[gcode_macro status_homing]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_homing
  set_nozzle_leds_on

[gcode_macro status_cleaning]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_cleaning
  set_nozzle_leds_on

[gcode_macro status_meshing]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_meshing
  set_nozzle_leds_on

[gcode_macro status_calibrating_z]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_calibrating_z
  set_nozzle_leds_on

[gcode_macro status_printing]
gcode:
  STOP_LED_EFFECTS
  SET_LED_EFFECT EFFECT=sb_logo_printing
  SET_LED_EFFECT EFFECT=sb_nozzle_printing
  SET_LED_EFFECT EFFECT=SKR_screen_button_printing
  SET_LED_EFFECT EFFECT=SKR_screen_printing
